# 2장. 데이터 액세스 기술

스프링은 주요 자바 데이터 액세스 기술을 모두 지원한다.

스프링이 지원한다는 의미는 스프링의 철학과 일관된 프로그래밍 모델을 유지하면서, 이런 기술을 사용할 수 있다는 뜻이다. 또한 스프링의 트랜잭션 추상화가 지원된다는 의미기도 하다.

# 2.1 공통개념

## 2.1.1 DAO 패턴

DAO 패턴은 DTO 또는 도메인 오브젝트만을 사용하는 인터페이스를 통해 데이터 액세스 기술을 외부에 노출하지 않도록 만드는 것이다.

이를 통해 DAO를 사용하는 코드에 영향을 주지 않고 데이터 액세스 기술을 변경하거나 하나 이상의 데이터 액세스 기술을 혼합해서 사용할 수 있게 해준다.

가장 중요한 장점은 DAO를 이용하는 서비스 계층의 코드를 기술이나 환경에 종속되지 않는 순수한 POJO로 개발할 수 있다는 것이다.

DAO 인터페이스와 DI

인터페이스를 만들 때 습관적으로 DAO 클래스의 모든 public 메소드를 추가하지 않도록 주의하자.

## 2.1.3 DataSource

connection은 모든 데이터 액세스 기술에서 사용되는 필수 리소스다.

애플리케이션 서버와 DB사이의 실제 커넥션을 매번 새롭게 만드는 건 비효율적이고 성능을 떨어뜨린다. 그래서 보통 미리 정해진 개수만큼의 DB 커넥션 풀에 준비해두고, 애플리케이션이 요청할 때마다 풀에서 꺼내 하나씩 할당해주고 다시 돌려받아서 풀에 넣는 식의 폴링기법을 이용한다.

스프링에서는 DataSource를 하나의 독립된 빈으로 등록하도록 강력하게 권장한다.

# 2.2 JDBC

JDBC는 자바의 데이터 액세스 기술의 기본이 되는 로우레벨의 API다. JDBC는 표준 인터페이스를 제공하고 각 DB 벤더와 개발팀에서 이 인터페이스를 구현한 드라이버를 제공하는 방식으로 사용된다. 그 덕분에 SQL의 호환성만 유지한다면 JDBC로 개발한 코드는 DB가 변경돼도 그대로 재사용할 수 있다는 장점이 있다.

엔티티 클래스와 애노테이션을 이용하는 최신 ORM 기술도 내부적으로는 DB와의 연동을 위해 JDBC를 이용한다.

스프링 JDBC가 해주는 작업

: JDBC프로그래밍에서 반복적으로 등장하는 판에 박힌 작업들이다.

- Connection 열기와 닫기
- Statement 준비와 닫기
- Statement 실행
- ResultSet 루프
- 예외처리와 반환
- 트랜잭션 처리

애노테이션 방식 : DataSource 수정자 메소드에 @AutoWired나 @Resource를 붙혀도 되고 리스트 2-3 과 같이 메소드에 의한 주입 방법이나 생성자 주입을 이용할 수도 있다.

## 2.2.5 스프링 JDBC DAO

스프링 개발자는 DAO에는 DataSource 타입의 빈을 DI 받은 뒤 DAO 코드에서 필요한 템플릿 오브젝트 등을 생성해두고 사용하는 방법을 자주쓴다.

![2%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%8B%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A6%E1%84%89%E1%85%B3%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF%2091bcc60bd9514a66982b3353557e6f20/Untitled.png](2%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%8B%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A6%E1%84%89%E1%85%B3%20%E1%84%80%E1%85%B5%E1%84%89%E1%85%AE%E1%86%AF%2091bcc60bd9514a66982b3353557e6f20/Untitled.png)

# 2.3 IBATIS SQLMaps

iBatis는 본격적인 ORM인 JPA나 하이버네이트처럼 새로운 DB 프로그래밍 패러타입을 익혀야하는 부담이 없다. 대부분의 개발자가 이미 익숙한 SQL을 그대로 이용할 수 있으면서도 JDBC 코드 작성의 불편함을 제거해주고, 도메인 오브젝트나 DTO를 중심으로 개발이 가능하다는 장점이 있다.

iBatis의 가장 큰 특징은 SQL을 자바 코드에서 분리해서 별도의 XML 파일 안에 작성하고 관리할 수 있다는 점이다.

# 2.4 JPA

JPA는 Java Persistent API의 약자로 EJB 3.0과 함게 등장한 JAVAEE와 JavaSE를 위한 영속성 관리와 O/R매핑(ORM) 을 위한 표준 기술이다.

ORM이란, 이렇게 오브젝트와 RDB사이에 존재하는 개념과 접근 방법, 성격의 차이 때문에 요구되는 불편한 작업을 제거해줘서 자바 개발자가 오브젝트를 가지고 정보를 다루면 ORM 프레임워크가 이를 RDB에 적절한 형태로 변환해주거나 그 반대로 RDB에 저장되어 있는 정보를 자바오브젝트가 다루기 쉬운 형태로 변환해주는 기술이다.

### 트랜잭션 매니저

JPA는 반드시 트랜잭션 안에서 동작하도록 설계되어있다.(JpaTransactionManager)

@Transanctional 이나 트랜잭션 AOP를 이용해서 트랜잭션 경계설정을 해주면 자동으로 JPA 트랜잭션을 시작하고 커밋하도록 만들 수 있다.

# 2.5 하이버네이트

하이버네이트는 가장 크게 성공한 오픈소스 ORM 프레임워크다.

복잡한 엔티티빈 대신 평점한 POJO로 SQL을 직접 사용하는 전통적인 방식 못지않게 강력하고 빠르면서도 편리한 ORM 방식의 개발이 가능함을 보여준 게 하이버네이트다. 스프링과 하이버네이트는 비슷한 시기에 POJO 프로그래밍을 바탕으로 자바엔터프라이즈 개발의 혁실을 가져온 대표적인 기술이다.

## 2.5.1 SessionFactory 등록

하이버네이트에는 JPA의 EntityManagerFactory처럼 핵심 엔진 역할을 하는 SessionFactory가 있다. SessionFactory는 엔티티 매핑정보와 설정 프로퍼티등을 이용해 초기화한 뒤에 애플리케이션에서 사용해야 한다.

## 2.5.2 Session과 HibernateTemplate

Session은 하이버네이트의 핵심 API다.

Session은 SessionFactory로부터 만들어지며 보통 트랜잭션과 동일한 스코프를 갖고 있다.

하이버네이트 DAO는 스프링이 관리하는 트랜잭션과 동기화된 Session을 가져와 사용한다.

스프링은 Session을 사용하는 두 가지 방법을 제공한다.

- HibernateTemplate
- SessionFactory.getCurrentSession()

# 2.6 트랜잭션

선언적 트랜잭션 경계설정 기능을 이용하면 코드내에서 직접 트랜잭션을 관리하고 트랜잭션 정보를 파라미터로 넘겨서 사용하지 않아도 된다. 선언적 트랜잭션의 가장 큰 장점은 트랜잭션 스크립트 방식의 코드를 탈피할 수 있다는 것이다.

트랜잭션 스크립트란, 하나의 트랜잭션안에서 동작해야 하는 코드를 한 군데 모아서 만드는 방식이다.

선언적 트랜잭션 경계설정을 사용하면 결국 코드의 중복을 제거하고 작은 단위의 컴포넌트로 쪼개서 개발한 후에 이를 조합해서 쓸 수 있다. 다양한 로직이 복잡하게 결합돼서 하나의 업무를 처리하는 엔터프라이즈 시스템의 요구조건을 가장 잘 충족시켜줄 기술이다.

### @Transactional

: 트랜잭션 AOP를 적용하는 두 번째 방법은 @Transactional 애노테이션을 이용하는 것이다. 

이 접근 방법에선 설정파일에 명시적으로 포인트컷과 어드바이스를 정의하지 않는다. 대신 트랜잭션이 적용될 타깃 인터페이스나 클래스, 메소드 등에 @Transactional 어노테이션을 부여해서 트랜잭션 대상으로 지정하고 트랜잭션의 속성을 제공한다. 

: 매우 세밀하게 트랜잭션 속성을 부여해야 할 경우라면 포인트컷고 트랜잭션 어드바이스로 한 번에 속성을 일괄 정요하는 것보다 유리하다.

프록시모드 : 스프링의 AOP는 기본적으로 다이내믹 프록시 기법을 이용해 동작한다.

: @Transactional 을 사용하는 경우에도 다음과 같이 proxy-target-class 애트리뷰트를 true로 바꿔주면 된다.

스프링의 aop는 기본적으로 프록시 방식이다.

## 2.6.3 트랜잭션 속성

### 트랜잭션 전파: propagation

- REQUIRED
- SUPPORTS
- MANDATORY
- REQUIRES_NEW
- NOT_SUPPORTED
- NEVER
- NESTED

### 트랜잭션 격리수준 : isolation

- DEFAULT
- READ_UNCOMMITTED
- READ_COMMITED
- REPEATABLE_READ
- SERIALIZABLE

### 트랜잭션 제한시간: timeout

### 읽기전용 트랜잭션: read-only, readOnly

### 트랜잭션 롤백 예외: rollback-for, rollbackFor, rollbackForClassName

### 트랜잭션 커밋 예외: no-rollback-for, noRollbackFor,noRollbackForclassName